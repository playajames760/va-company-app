{% extends 'base.html' %}
{% block content %}
<div class="p-4 bg-white rounded shadow-sm">
  <h2 class="mb-3">Crew / Pilot Flight Log Entry</h2>
  <p class="text-muted small">Capture actual operational results for a completed leg. Use UTC/Z for block off/on times, calculate block time in hh:mm, and record cargo carried on this segment (not total day). Remarks should briefly note weather, ATC issues, safety items, or route variations. Complete immediately after shutdown while details are fresh.</p>
  {% include '_flow_help.html' %}
  <div class="alert alert-secondary small mb-3" id="crewGuideBox">
    <strong>Before Flight:</strong> Ensure a Dispatch Release exists. <strong>After Loading:</strong> Record any cargo in its manifest. <strong>Now:</strong> Enter actual times and conditions. Use the dynamic links below to review or create related forms.
    <div class="mt-1">
      <a id="crewToDispatch" href="#">Dispatch Release</a> |
      <a id="crewToCargo" href="#">Cargo Manifest</a>
    </div>
  </div>
  <form method="post" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control" value="{{ defaults.date }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Flight ID</label>
      <input type="text" name="flight_id" class="form-control" placeholder="PRA123" value="{{ defaults.flight_id }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">From (ICAO)</label>
      <input type="text" name="origin" class="form-control" placeholder="KPOC" value="{{ defaults.origin }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">To (ICAO)</label>
      <input type="text" name="destination" class="form-control" placeholder="KCRQ" value="{{ defaults.destination }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Aircraft / Reg</label>
      <input type="text" name="aircraft" class="form-control" placeholder="C172 N17PR" value="{{ defaults.aircraft }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Block Off (Z)</label>
      <input type="text" name="block_off" class="form-control" placeholder="0130Z" value="{{ defaults.block_off }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Block On (Z)</label>
      <input type="text" name="block_on" class="form-control" placeholder="0235Z" value="{{ defaults.block_on }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Block Time (hh:mm)</label>
      <input type="text" name="block_time" class="form-control" placeholder="01:05" value="{{ defaults.block_time }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Cargo (lbs)</label>
      <input type="text" name="cargo_weight" class="form-control" value="{{ defaults.cargo_weight }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Fuel Used (units)</label>
      <input type="text" name="fuel_used" class="form-control" placeholder="Actual fuel" value="{{ defaults.fuel_used }}">
    </div>
    <div class="col-12">
      <label class="form-label">Remarks / Route Segment</label>
      <textarea name="remarks" rows="3" class="form-control" placeholder="Notes on weather, ATC, performance, etc.">{{ defaults.remarks }}</textarea>
    </div>
    <div class="col-md-6">
      <label class="form-label">Link Dispatch Release (optional)</label>
      <select name="dispatch_release_id" class="form-select">
        <option value="">-- None --</option>
        {% for dr in dispatch_options %}
          <option value="{{ dr.id }}" {% if dr.id|string == defaults.dispatch_release_id|string %}selected{% endif %}>#{{ dr.id }} {{ dr.date }} {{ dr.flight_id }} {{ dr.departure }}→{{ dr.destination }} {% if dr.completed==1 %}(Completed){% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Link Cargo Manifest (optional)</label>
      <select name="cargo_manifest_id" class="form-select">
        <option value="">-- None --</option>
        {% for cm in cargo_manifest_options %}
          <option value="{{ cm.id }}" {% if cm.id|string == defaults.cargo_manifest_id|string %}selected{% endif %}>#{{ cm.id }} {{ cm.date }} {{ cm.flight_id }} {{ cm.departure }}→{{ cm.arrival }} ({{ cm.total_weight }} lbs)</option>
        {% endfor %}
      </select>
    </div>
    </div>
    <div class="col-12 d-flex justify-content-between align-items-center mt-3">
      <a href="{{ url_for('crew_history') }}" class="btn btn-outline-secondary">View History</a>
      <button type="submit" class="btn btn-primary">Save Log Entry</button>
    </div>
  </form>
</div>
<script>
 (function(){
   function buildLinks(){
     const date = document.querySelector('input[name=date]').value;
     const flight = document.querySelector('input[name=flight_id]').value;
     const aircraft = document.querySelector('input[name=aircraft]').value;
     const origin = document.querySelector('input[name=origin]').value;
     const destination = document.querySelector('input[name=destination]').value;
     const dispatchUrl = `{{ url_for('dispatch') }}?date=${encodeURIComponent(date)}&flight_id=${encodeURIComponent(flight)}&aircraft=${encodeURIComponent(aircraft)}&departure=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
     const cargoUrl = `{{ url_for('cargo') }}?date=${encodeURIComponent(date)}&flight_id=${encodeURIComponent(flight)}&aircraft=${encodeURIComponent(aircraft)}&departure=${encodeURIComponent(origin)}&arrival=${encodeURIComponent(destination)}`;
     document.getElementById('crewToDispatch').href = dispatchUrl;
     document.getElementById('crewToCargo').href = cargoUrl;
   }
   document.querySelectorAll('form input').forEach(el=>el.addEventListener('input', buildLinks));
   buildLinks();
 })();
</script>
{% endblock %}
