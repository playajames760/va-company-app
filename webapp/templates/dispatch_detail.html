{% extends 'base.html' %}
{% block content %}
<div class="p-4 bg-white rounded shadow-sm">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Dispatch Release #{{ d.id }} – {{ d.flight_id }}</h2>
    <a href="{{ url_for('dispatch_history') }}" class="btn btn-outline-secondary btn-sm">Back to History</a>
  </div>
  <p class="text-muted small mb-3">Comprehensive flight/job description including planning, cargo expectations, weather, and special instructions.</p>
  <div class="row g-3">
    <div class="col-md-3">
      <div class="fw-semibold">Date</div>
      <div>{{ d.date }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Flight ID</div>
      <div>{{ d.flight_id }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Aircraft</div>
      <div>{{ d.aircraft }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Dep → Dest</div>
      <div>{{ d.departure }} → {{ d.destination }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Off-Blocks (Z)</div>
      <div>{{ d.offblocks }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Arrival (Z)</div>
      <div>{{ d.arrival }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Payload Planned (lbs)</div>
      <div>{{ d.payload_planned or '—' }}</div>
      {% if d.actual_cargo_weight %}<div class="small text-muted">Actual Cargo: {{ d.actual_cargo_weight }} lbs</div>{% endif %}
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Fuel Planned</div>
      <div>{{ d.fuel_planned or '—' }}</div>
    </div>
    <div class="col-md-3">
      <div class="fw-semibold">Financial Summary</div>
      <div class="small">Rev: {{ '%.2f'|format(fin_summary.revenue) }} | Cost: {{ '%.2f'|format(fin_summary.costs) }} | Profit: {{ '%.2f'|format(fin_summary.profit) }}</div>
    </div>
    <div class="col-md-6">
      <div class="fw-semibold">Alternate Airports</div>
      <div class="small">{{ d.alt_airports or '—' }}</div>
    </div>
    <div class="col-md-6">
      <div class="fw-semibold">Cargo Plan</div>
      <div class="small">{{ d.cargo_plan or '—' }}</div>
    </div>
    <div class="col-md-6">
      <div class="fw-semibold">Weather Brief</div>
      <div class="small">{{ d.weather_brief or '—' }}</div>
    </div>
    <div class="col-md-6">
      <div class="fw-semibold">Special Notes / Instructions</div>
      <div class="small">{{ d.special_notes or '—' }}</div>
    </div>
    <div class="col-12">
      <div class="fw-semibold">Route / Remarks</div>
      <pre class="small bg-light p-2 border rounded" style="white-space:pre-wrap">{{ d.route }}</pre>
    </div>
    {% if d.flight_plan_raw %}
    <div class="col-12">
      <div class="fw-semibold">Uploaded Flight Plan ({{ d.flight_plan_source or 'unknown' }})</div>
      <details class="small">
        <summary class="text-muted">Show Raw Plan Content</summary>
        <pre class="small bg-light p-2 border rounded" style="white-space:pre-wrap; max-height:300px; overflow:auto;">{{ d.flight_plan_raw }}</pre>
      </details>
    </div>
    {% endif %}
    {% if d.briefing_pdf_filename %}
    <div class="col-12">
      <div class="fw-semibold">Briefing PDF</div>
      <div class="border rounded mb-2" style="height:800px;">
        <iframe src="{{ url_for('dispatch_briefing_pdf', id=d.id) }}" title="Briefing PDF" style="width:100%;height:100%;border:0;" allowfullscreen></iframe>
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dispatch_briefing_pdf', id=d.id) }}" target="_blank" rel="noopener">Open / Download PDF</a>
    </div>
    {% endif %}
    {% if pln %}
    <div class="col-12">
      <div class="fw-semibold mb-1">Parsed .pln Structure</div>
      <div class="small mb-2">
        {% if pln.cruising_alt %}Cruise: {{ pln.cruising_alt }} ft{% else %}Cruise: —{% endif %} |
        Dep RWY: {{ pln.departure_runway or '—' }} | Arr RWY: {{ pln.arrival_runway or '—' }} | Approach: {{ pln.approach_type or '—' }}
      </div>
      {% if pln.route_str %}
        <div class="small mb-2"><span class="fw-semibold">Reconstructed Route:</span> {{ pln.route_str }}</div>
      {% endif %}
      {% if pln.waypoints %}
      <div class="table-responsive">
        <table class="table table-sm table-bordered small mb-0">
          <thead class="table-light">
            <tr><th>#</th><th>Ident</th><th>Type</th><th>Airway (segment start)</th></tr>
          </thead>
          <tbody>
            {% for wp in pln.waypoints %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ wp.ident }}</td>
                <td>{{ wp.type or '—' }}</td>
                <td>{{ wp.airway or '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="small text-muted mb-0">No waypoints parsed.</p>
      {% endif %}
    </div>
    {% endif %}
  </div>
  <hr>
  <h3 class="h6">Linked Cargo Manifests</h3>
  {% if linked_manifests %}
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle mb-0">
        <thead><tr><th>#</th><th>Date</th><th>Flight</th><th>Dep→Arr</th><th>Weight</th><th>Pieces</th><th>Actions</th></tr></thead>
        <tbody>
        {% for m in linked_manifests %}
          <tr>
            <td>{{ m.id }}</td>
            <td>{{ m.date }}</td>
            <td>{{ m.flight_id }}</td>
            <td>{{ m.departure }} → {{ m.arrival }}</td>
            <td>{{ m.total_weight }}</td>
            <td>{{ m.pieces }}</td>
            <td class="text-nowrap">
              <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('cargo_detail', id=m.id) }}">View/Edit</a>
              <form method="post" action="{{ url_for('dispatch_unlink_manifest', dispatch_id=d.id, manifest_id=m.id) }}" class="d-inline" onsubmit="return confirm('Unlink this cargo manifest?');">
                <button class="btn btn-danger btn-sm">Unlink</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted small mb-0">No cargo manifests linked.</p>
  {% endif %}
  <hr>
  <div class="d-flex gap-2 flex-wrap">
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('cargo', date=d.date, flight_id=d.flight_id, aircraft=d.aircraft, departure=d.departure, arrival=d.destination, dispatch_release_id=d.id) }}">Create Cargo Manifest</a>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('crew', date=d.date, flight_id=d.flight_id, origin=d.departure, destination=d.destination, aircraft=d.aircraft, dispatch_release_id=d.id) }}">Create Crew Log</a>
    <a class="btn btn-outline-warning btn-sm" href="{{ url_for('dispatch_edit', id=d.id) }}">Edit Release</a>
    <a class="btn btn-outline-info btn-sm" href="{{ url_for('dispatch_simbrief', id=d.id) }}" target="_blank" rel="noopener">SimBrief Prefill</a>
  </div>
</div>
{% endblock %}
