{% extends 'base.html' %}
{% block content %}
<div class="p-4 bg-white rounded shadow-sm">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Crew Log #{{ c.id }} – {{ c.flight_id }}</h2>
    <div class="btn-group btn-group-sm">
      {% if current_employee and current_employee.role in ['Manager','Administrator'] %}
        <a href="#editForm" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('editForm').classList.toggle('d-none');return false;">{{ 'Hide Edit' if request.args.get('edit') else 'Edit' }}</a>
      {% endif %}
    </div>
  </div>
  {% if c.dispatch_release_id %}
    <div class="alert alert-info small mb-3">Linked to Dispatch Release <a href="{{ url_for('dispatch_detail', id=c.dispatch_release_id) }}" class="alert-link">#{{ c.dispatch_release_id }}</a>.</div>
  {% endif %}
  {% if c.cargo_manifest_id %}
    <div class="alert alert-secondary small mb-3">Linked to Cargo Manifest <a href="{{ url_for('cargo_detail', id=c.cargo_manifest_id) }}" class="alert-link">#{{ c.cargo_manifest_id }}</a>.</div>
  {% endif %}
  <dl class="row mb-0">
    <dt class="col-sm-3">Date</dt><dd class="col-sm-9">{{ c.date }}</dd>
    <dt class="col-sm-3">Flight ID</dt><dd class="col-sm-9">{{ c.flight_id }}</dd>
    <dt class="col-sm-3">Origin</dt><dd class="col-sm-9">{{ c.origin }}</dd>
    <dt class="col-sm-3">Destination</dt><dd class="col-sm-9">{{ c.destination }}</dd>
    <dt class="col-sm-3">Aircraft</dt><dd class="col-sm-9">{{ c.aircraft }}</dd>
    <dt class="col-sm-3">Block Off</dt><dd class="col-sm-9">{{ c.block_off }}</dd>
    <dt class="col-sm-3">Block On</dt><dd class="col-sm-9">{{ c.block_on }}</dd>
    <dt class="col-sm-3">Block Time</dt><dd class="col-sm-9">{{ c.block_time }}</dd>
    <dt class="col-sm-3">Cargo Weight (lbs)</dt><dd class="col-sm-9">{{ c.cargo_weight }}</dd>
    <dt class="col-sm-3">Fuel Used</dt><dd class="col-sm-9">{{ c.fuel_used or '—' }}</dd>
    <dt class="col-sm-3">Remarks</dt><dd class="col-sm-9"><pre class="small bg-light p-2 border rounded" style="white-space:pre-wrap">{{ c.remarks }}</pre></dd>
  </dl>
  <div class="mt-4">
    <h3 class="h6">Sign-Offs</h3>
    <hr class="my-3">
    <div>
      <h5 class="h6 mb-2">Crew Log Sign-Offs</h5>
      {% if signoffs and signoffs|length > 0 %}
        <ul class="list-unstyled small mb-2">
          {% for so in signoffs %}
            <li class="mb-1">✍️ {{ so.employee.name }} ({{ so.employee.role }}) – {{ so.timestamp.strftime('%Y-%m-%d %H:%MZ') }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="small text-muted mb-2">No sign-offs yet.</p>
      {% endif %}
      {% if current_employee %}
        <form method="post" action="{{ url_for('crew_sign', id=c.id) }}" class="d-inline">
          <button class="btn btn-outline-success btn-sm" {% if signoffs and signoffs|selectattr('employee_id','equalto', current_employee.id)|list|length > 0 %}disabled{% endif %}>Sign Crew Log</button>
        </form>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm">Login to sign</a>
      {% endif %}
    </div>
  </div>
  <div class="mt-4 d-flex justify-content-end">
    {% if (c.dispatch_release_id or c.cargo_manifest_id) and current_employee and current_employee.role in ['Manager','Administrator'] %}
      <form action="{{ url_for('crew_unlink', id=c.id) }}" method="post" class="d-inline me-2" onsubmit="return confirm('Unlink this crew log from its dispatch and cargo manifest?');">
        <button class="btn btn-outline-warning btn-sm">Unlink</button>
      </form>
    {% endif %}
    <form action="{{ url_for('delete_crew', id=c.id) }}" method="post" class="d-inline" onsubmit="return confirm('Delete this crew log entry?');">
      <button class="btn btn-outline-danger btn-sm">Delete Log</button>
    </form>
  </div>
  {% if current_employee and current_employee.role in ['Manager','Administrator'] %}
  <div id="editForm" class="d-none mt-4">
    <h3 class="h6 mb-3">Edit Crew Log</h3>
    <form method="post" action="{{ url_for('crew_edit', id=c.id) }}" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Date</label>
        <input type="date" name="date" class="form-control" value="{{ c.date }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Flight ID</label>
        <input type="text" name="flight_id" class="form-control" value="{{ c.flight_id }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Origin</label>
        <input type="text" name="origin" class="form-control" value="{{ c.origin }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Destination</label>
        <input type="text" name="destination" class="form-control" value="{{ c.destination }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Aircraft</label>
        <input type="text" name="aircraft" class="form-control" value="{{ c.aircraft }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Block Off (Z)</label>
        <input type="text" name="block_off" class="form-control" value="{{ c.block_off }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Block On (Z)</label>
        <input type="text" name="block_on" class="form-control" value="{{ c.block_on }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Block Time</label>
        <input type="text" name="block_time" class="form-control" value="{{ c.block_time }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Cargo (lbs)</label>
        <input type="text" name="cargo_weight" class="form-control" value="{{ c.cargo_weight }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Fuel Used</label>
        <input type="text" name="fuel_used" class="form-control" value="{{ c.fuel_used }}">
      </div>
      <div class="col-12">
        <label class="form-label">Remarks</label>
        <textarea name="remarks" rows="3" class="form-control">{{ c.remarks }}</textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label">Dispatch Release Link</label>
        <select name="dispatch_release_id" class="form-select">
          <option value="">-- None --</option>
          {% for dr in dispatch_options %}
            <option value="{{ dr.id }}" {% if dr.id == c.dispatch_release_id %}selected{% endif %}>#{{ dr.id }} {{ dr.date }} {{ dr.flight_id }} {{ dr.departure }}→{{ dr.destination }} {% if dr.completed==1 %}(Completed){% endif %}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Cargo Manifest Link</label>
        <select name="cargo_manifest_id" class="form-select">
          <option value="">-- None --</option>
          {% for cm in cargo_manifest_options %}
            <option value="{{ cm.id }}" {% if cm.id == c.cargo_manifest_id %}selected{% endif %}>#{{ cm.id }} {{ cm.date }} {{ cm.flight_id }} {{ cm.departure }}→{{ cm.arrival }} ({{ cm.total_weight }} lbs)</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 d-flex justify-content-between align-items-center mt-3">
        <a href="{{ url_for('crew_history') }}" class="btn btn-outline-secondary">Back to History</a>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}